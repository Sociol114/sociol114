{
  "hash": "23dc720a600779a675ff9667e5188728",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Discussion. Parametric g-formula: Outcome modeling\"\nauthor: Cornell STSCI / INFO / ILRST 3900 \\break Fall 2023 \\break \\href{https://causal3900.github.io/}{\\textcolor{blue}{causal3900.github.io}}\ndate: 27 Sep 2023\nformat: beamer\ndate-format: DD MMM YYYY\nheader-includes:\n  \\usecolortheme{dove}\n  \\usepackage{tikz}\n  \\usetikzlibrary{arrows,shapes.arrows,positioning,shapes,patterns,calc}\n---\n\n\n\n\n\n## Where lecture ended\n\n\\centering\n\n\n\n```{=tex}\n\\begin{tikzpicture}[x = 1in, y = .4in]\n\\node (a) at (0,0) {$A$};\n\\node (y) at (1,0) {$Y$};\n\\node (l1) at (-1,2) {$L_1$};\n\\node (l2) at (-1,1.66) {$L_2$};\n\\node (l3) at (-1,1.33) {$L_3$};\n\\node (l4) at (-1,1) {$L_4$};\n\\node (l5) at (-1,.66) {$L_5$};\n\\node (l6) at (-1,.33) {$L_6$};\n\\node (l7) at (-1,0) {$L_7$};\n\\draw[->, thick] (l1) -- (a);\n\\draw[->, thick] (l2) -- (a);\n\\draw[->, thick] (l3) -- (a);\n\\draw[->, thick] (l4) -- (a);\n\\draw[->, thick] (l5) -- (a);\n\\draw[->, thick] (l6) -- (a);\n\\draw[->, thick] (l7) -- (a);\n\\draw[->, thick] (a) -- (y);\n\\draw[->, thick] (l1) to[bend left] (y);\n\\draw[->, thick] (l2) to[bend left] (y);\n\\draw[->, thick] (l3) to[bend left] (y);\n\\draw[->, thick] (l4) to[bend left] (y);\n\\draw[->, thick] (l5) to[bend left] (y);\n\\draw[->, thick] (l6) to[bend left] (y);\n\\draw[->, thick] (l7) to[bend left] (y);\n\\node[anchor = north, align = center, font = \\footnotesize] at (a.south) {College\\\\Degree\\\\by Age 25};\n\\node[anchor = north, align = center, font = \\footnotesize] at (y.south) {Spouse\\\\at Age 35\\\\Has Degree};\n\\node[anchor = east, align = center, font = \\footnotesize] at (l1.west) {Sex};\n\\node[anchor = east, align = center, font = \\footnotesize] at (l2.west) {Race};\n\\node[anchor = east, align = center, font = \\footnotesize] at (l3.west) {Mom Education};\n\\node[anchor = east, align = center, font = \\footnotesize] at (l4.west) {Dad Education};\n\\node[anchor = east, align = center, font = \\footnotesize] at (l5.west) {Income};\n\\node[anchor = east, align = center, font = \\footnotesize] at (l6.west) {Wealth};\n\\node[anchor = east, align = center, font = \\footnotesize] at (l7.west) {Test Percentile};\n\\end{tikzpicture}\n```\n\n\n\\huge\n\n**100%** of the sample\n\n\\normalsize\n\nis in a subgroup with either 0 treated or 0 untreated units\n\n## Setup\n\nFollow the instructions on Ed to download the data!\n\n\n\n\n\n\n\n## Statistical modeling\n\nUnder exchangeability, $$E\\left(Y^a\\mid\\vec{L} = \\vec\\ell\\right) = E\\left(Y\\mid A = a, \\vec{L} = \\vec\\ell\\right)$$\n\nTo estimate, we have been taking the subgroup mean $$\\hat{E}(Y\\mid A = a, \\vec{L} = \\vec\\ell) = \\frac{1}{n_{a,\\vec\\ell}}\\sum_{i:A_i=a,\\vec{L}_i=\\vec\\ell} Y_i$$ When subgroups are empty, we need a model. Example:\n\n$$\\hat{E}\\left(Y\\mid A = a, \\vec{L} = \\vec\\ell\\right) = \\hat\\alpha + A\\hat\\beta + \\vec{L}'\\hat{\\vec\\gamma} + A\\vec{L}'\\hat{\\vec\\eta}$$\n\n## Parametric g-formula: Outcome modeling\n\n1.  Learn a model to predict $Y$ given $\\{A,\\vec{L}\\}$\n2.  For each $i$, predict\n    -   $\\{A = 1,\\vec{L} = \\vec\\ell_i\\}$, the conditional average outcome under treatment\n    -   $\\{A = 0, \\vec{L} = \\vec\\ell_i\\}$, the conditional average outcome under control\n3.  Take the difference for each unit\n4.  Average over the units\n\n## 1. Learn a model to predict $Y$ given $\\{A,\\vec{L}\\}$\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit <- lm(y ~ a*(sex + race + mom_educ + dad_educ + \n                   log_parent_income + \n                   log_parent_wealth + \n                   test_percentile),\n          data = d,\n          family = binomial)\n```\n:::\n\n\n\n## 2. Predict conditional average potential outcomes for every unit\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconditional_average_outcomes <- d %>%\n  mutate(yhat1 = predict(fit, \n                         newdata = d %>% \n                           mutate(a = \"college\")),\n         yhat0 = predict(fit, \n                         newdata = d %>% \n                           mutate(a = \"no_college\")))\n```\n:::\n\n\n\n## 3. Difference to estimate conditional average effects\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconditional_average_effects <- \n  conditional_average_outcomes %>%\n  mutate(effect = yhat1 - yhat0)\n```\n:::\n\n\n\n## 4. Average over units\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconditional_average_effects %>%\n  select(yhat1, yhat0, effect) %>%\n  summarize_all(.funs = mean)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 x 3\n  yhat1 yhat0 effect\n  <dbl> <dbl>  <dbl>\n1 0.404 0.163  0.241\n```\n\n\n:::\n:::\n\n\n\n## Recap. Parametric g-formula: Outcome modeling\n\n1.  Learn a model to predict $Y$ given $\\{A,\\vec{L}\\}$\n2.  For each $i$, predict\n    -   $\\{A = 1,\\vec{L} = \\vec\\ell_i\\}$, the conditional average outcome under treatment\n    -   $\\{A = 0, \\vec{L} = \\vec\\ell_i\\}$, the conditional average outcome under control\n3.  Take the difference for each unit\n4.  Average over the units\n\n## Extension 1: Conditional average effects\n\nModify the procedure above to estimate the average effect in subgroups defined by mom's education:\n\n1.  those with `sex == Male`\n2.  those with `sex == Female`\n\nIf you finish, choose a subgroup of interest to you and summarize.\n\n. . .\n\nOne way to code it:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconditional_average_effects %>%\n  group_by(sex) %>%\n  select(sex, yhat0,yhat1,effect) %>%\n  summarize_all(.funs = mean)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 x 4\n  sex    yhat0 yhat1 effect\n  <chr>  <dbl> <dbl>  <dbl>\n1 Female 0.129 0.348  0.219\n2 Male   0.196 0.460  0.263\n```\n\n\n:::\n:::\n\n\n\n## Extension 2: Logistic regression\n\nIn groups: Repeat the steps above with logistic regression\n\n$$\\text{log}\\left(\\frac{\\hat{P}\\left(Y\\mid A = a, \\vec{L} = \\vec\\ell\\right)}{1 - \\hat{P}\\left(Y\\mid A = a, \\vec{L} = \\vec\\ell\\right)}\\right) = \\hat\\alpha + A\\hat\\beta + \\vec{L}'\\hat{\\vec\\gamma} + A\\vec{L}'\\hat{\\vec\\eta}$$ Helpful hints:\n\n-   read about using `glm()` to estimate logistic regression\n-   when using `predict()`, search to find out how to predict probabilities\n\n## Extension: Logistic regression\n\nFit a model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit <- glm(y ~ a*(sex + race + mom_educ + dad_educ + \n                    log_parent_income + \n                    log_parent_wealth + \n                    test_percentile),\n           data = d,\n           family = binomial)\n```\n:::\n\n\n\n## Extension: Logistic regression\n\nPredict and summarize to estimate the average effect\n\n\\footnotesize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd %>%\n  mutate(yhat1 = predict(fit, \n                         newdata = d %>% \n                           mutate(a = \"college\"), \n                         type = \"response\"),\n         yhat0 = predict(fit, \n                         newdata = d %>% \n                           mutate(a = \"no_college\"), \n                         type = \"response\"),\n         effect = yhat1 - yhat0) %>%\n  select(yhat1,yhat0,effect) %>%\n  summarize_all(.funs = mean)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 x 3\n  yhat1 yhat0 effect\n  <dbl> <dbl>  <dbl>\n1 0.406 0.165  0.241\n```\n\n\n:::\n:::\n\n\n\n## Recap. Parametric g-formula: Outcome modeling\n\n1.  Learn a model to predict $Y$ given $\\{A,\\vec{L}\\}$\n2.  For each $i$, predict\n    -   $\\{A = 1,\\vec{L} = \\vec\\ell_i\\}$, the conditional average outcome under treatment\n    -   $\\{A = 0, \\vec{L} = \\vec\\ell_i\\}$, the conditional average outcome under control\n3.  Take the difference for each unit\n4.  Average over the units\n",
    "supporting": [
      "lec14_causal_outcome_model_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}